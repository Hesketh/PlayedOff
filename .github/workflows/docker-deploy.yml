name: Build and Deploy Docker Containers

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  IMAGE_PREFIX: playedoff
  DOCKER_CLI_EXPERIMENTAL: enabled

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Set up Docker
      uses: crazy-max/ghaction-setup-docker@v2
      with:
        version: v24.0.6
        daemon-config: |
          {
            "features": {
              "containerd-snapshotter": true
            }
          }

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Log in to private Docker registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build API docker image
      run: |
        dotnet publish PlayedOff.Api/PlayedOff.Api.csproj \
          -c Release \
          -p:PublishProfile=DefaultContainer \
          -p:ContainerRepository=$REGISTRY/$IMAGE_PREFIX-api \
          -p:ContainerImageTag=latest

    - name: Push API docker image
      run: |
        docker push $REGISTRY/$IMAGE_PREFIX-api:latest

    - name: Build and push Website docker image
      run: |
        docker build -t $REGISTRY/$IMAGE_PREFIX-web:latest -f PlayedOff.Web/Dockerfile .
        docker push $REGISTRY/$IMAGE_PREFIX-web:latest